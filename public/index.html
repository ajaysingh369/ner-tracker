<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tej Kadam Foundation</title>
    <script src="script.js"></script>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="styles.css">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> -->
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div class="header-text">
                    <h1>Tej Kadam Foundation</h1>
                    <h2>BADHTE KADAM</h2>
                    <p>☀️ Virtual Run Challenge <span class="date-range">(1st Aug - 31st Aug)</p>
                    <!-- <p>👣 Step Up. Stand Out. 👣</p> -->
                </div> 
            </div>
            <div class="theme-toggle"><input type="checkbox" id="theme"></div>
        </header>

        <!-- Main Content -->
        <main class="app-main">

            <div id="leaderboard-container">
                <!-- <button id="authButton" class="auth-button">
                    <span>Authorize with Strava</span><p class="auth-subtext">*if your name is missing from the list. Your name & data will be display from 1st Aug</p>
                </button> -->
                <!-- Loader -->
                <div id="loader" class="loader"><span class="running-emoji">🏃‍♂️</span><span class="loading-text">Loading</span></div>

                <div id="categoryFilters" class="category-filters">
                    <button class="filter-button selected" data-category="100">100 KM (Lakshaya)</button>
                    <button class="filter-button" data-category="150">150 KM (Udaan)</button>
                    <button class="filter-button" data-category="200">200 KM (Bhaag Milkha Bhaag)</button>
                </div>

                <!-- <img class="maintain-img" src="https://twemoji.maxcdn.com/v/latest/svg/1f6e0.svg" alt="Under Construction" />
                <h1 class="maintain-title">We’re getting ready!</h1>
                <p class="maintain-desc">The tracker is under maintenance as we prepare for the August challenge.<br>
                    Please check back soon. 🏃‍♀️🏃‍♂️
                </p> -->

                <!-- Medals Section -->
                <!-- <div class="medals-container" id="medallist">
                    <h2>🏅 Top Performers</h2><div id="medals" class="medals-grid"><p></p><p></p><p></p></div>
                </div> -->
                <!-- <div class="medals-container" id="medallist">
                    <h2>🏅 Leaderboard</h2><div id="medals" class="medals-grid"><p></p><p></p><p></p></div>
                </div> -->
            
                <!-- Calendar Table -->
                <div class="activity-table">
                    <h2>Leaderboard</h2>
                    <!-- <h2>Team Activities</h2> -->
                    <!-- <p class="points-info"><strong>5 mins activity rewards:</strong> 🏃Run - <b>0.9</b>, 🧘/💪 Yoga/Strength - <b>1pts</b></p> -->
                     <p class="glowing-note">To make sure all your activities are counted correctly (even those late-night runs close to midnight 🕛), we sync data up to yesterday. Don’t worry—anything you record today will safely appear in the tracker tomorrow. Keep running strong! 🏃‍♀️🏃‍♂️✨</p>
                    <input type="text" id="searchAthlete" placeholder="🔍 Search Athlete..." class="search-box">
                </div>
                <div class="calendar-container" id="actlist">
                    <table id="calendarTable">
                        <thead id="calendarHeader"></thead>
                        <tbody id="calendarBody"></tbody>
                    </table>
                </div>
            </div>


            <div class="MuiCardContent-root css-15q2cw4">
                <h4>बढ़ते कदम Virtual Run</h4>
                <div>
                    <p>Aug 1 - Aug 31, 2025 | Anytime</p>
                </div>
                <div class="event-description">
                    <p>Tej Kadam Foundation and AAV Group proudly present “BADHTE KADAM” – a 31-day virtual run/walk challenge to kickstart or boost your fitness journey!</p>
                    <ol style="padding: 1rem;">
                        <li>Open for all – especially beginners</li>
                        <li>Walk or run at your pace, anytime, anywhere</li>
                        <li>Track your progress &amp; stay motivated</li>
                    </ol>
                    <p>This is your moment to break boundaries and create a healthier, stronger you through daily movement.</p>
            
                    <strong>Activity Related Instructions</strong>
                    <ul style="padding: 1rem;">
                        <li>You can run or walk anytime, anywhere during the challenge.</li>
                        <li>Each activity must be at least 2 kilometres to be valid.</li>
                        <li>You can log more than one activity in a day.</li>
                        <li>Any activity less than 2 kilometres will not be counted.</li>
                    </ul>
                    <strong>Qualification Related Instructions</strong>
                    <ul style="padding: 1rem;">
                        <li>You must complete at least 22 active days in the event month.</li>
                        <li>An active day means logging at least one valid activity (2 km or more).</li>
                        <li>Only Strava-recorded activities will be considered.</li>
                        <li>No manual entries or screenshots from other apps will be accepted.</li>
                    </ul>
                    <strong>Deliverables to Participants</strong>
                    <ul style="padding: 1rem;">
                        <li>You are using this special dashboard to track your daily activities (Please check "App related instructions below").</li>
                        <li>Participants who successfully complete the challenge will be rewarded for their consistency and effort.</li>
                        <li>Regular monitoring of activities will be done to ensure fair participation.</li> 
                        <li>Our team will also provide timely updates and motivation to keep you going!</li>
                    </ul>
                    <strong>App Related Instructions</strong>
                    <ul style="padding: 1rem;">
                    <li>Download the Strava app from the Play Store or App Store </li>
                    <li>If you don’t have a Strava account, create one for free.</li>
                    <li>Use only Strava to record your running/walking activities.</li>
                    <li>Make sure your activities are visible to “Everyone” in Strava settings.</li>
                    <li>Please record your activity as “Run” in Strava, even if you are doing a walk.</li>
                    <!-- <li><strong>Just to make sure that all your valid activities must be counted for day, even you have recorded it late night  before 12, we sync till yesterday. So dont worry, keep recording your activities today, it will reflect tomorrow for sure :)</strong></li> -->
                    </ul>


        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="social-links">
                <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook"></i></a>
                <a href="https://twitter.com" target="_blank"><i class="fab fa-twitter"></i></a>
                <a href="https://www.instagram.com/noidaextensionrunners/#" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://strava.com/athletes/123859756" class="strava-badge- strava-badge-follow" target="_blank"><img src="icons/echelon-sprite-24.png" alt="Strava" /></a>
            </div>
            <div>&copy; 2025 Tej Kadam Foundation. All rights reserved.</div>
        </footer>
    </div>

    <!-- Activity Details Popup -->
    <div id="activityPopup" class="popup">
        <div class="popup-content">
            <span id="closePopup" class="close" onclick="closePopup('activityPopup')">&times;</span>
            <h3>Activity Details</h3>
            <div id="activityDetails"></div>
        </div>
    </div>

    <!-- Athlete Profile Popup -->
    <div id="profilePopup" class="popup">
        <div class="popup-content">
            <span id="closeProfilePopup" class="close" onclick="closePopup('profilePopup')">&times;</span>
            <h3>Athlete Profile</h3>
            <div id="profileDetails" class="profile-popup-divider">
                <img id="profilePhoto" alt="Profile Photo" class="profile-photo-large">
                <p id="profileName"></p>
                <p id="profileActivities"></p>
            </div>
        </div>
    </div>
    <script>
        // Load dark mode setting
        document.addEventListener("DOMContentLoaded", () => {
            const authButton = document.getElementById('authButton');
            const loader = document.getElementById('loader');
            const calendarHeader = document.getElementById('calendarHeader');
            const calendarBody = document.getElementById('calendarBody');
            const activityPopup = document.getElementById('activityPopup');
            const profilePhoto = document.getElementById('profilePhoto');
            const profileName = document.getElementById('profileName');
            const profileActivities = document.getElementById('profileActivities');
            const themeToggle = document.getElementById('theme');

            // Toggle dark mode and save setting
            themeToggle.addEventListener("change", () => {
                const isDarkMode = themeToggle.checked;
                document.body.setAttribute("data-theme", isDarkMode ? "dark" : "light");
                localStorage.setItem("darkMode", isDarkMode);
            });
            const darkModeEnabled = localStorage.getItem("darkMode") === "true";
            
            themeToggle.checked = darkModeEnabled;
            document.body.setAttribute("data-theme", darkModeEnabled ? "dark" : "light");   
                
            // Attach search event listener
            document.getElementById('searchAthlete').addEventListener('input', debounced(filterAthletes, 250));
            //document.getElementById('searchAthlete').addEventListener('input', filterAthletes);

            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    const selectedCategory = btn.dataset.category;
                    fetchEventData("tkfvr", "7", selectedCategory);
                });
            });

            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <th>Athlete</th>
                ${[...Array(31).keys()].map(d => `<th>${d + 1} Aug</th>`).join("")}
            `;
            calendarHeader.appendChild(headerRow);

            // Initial load
            fetchEventData("tkfvr", "7", "100");
        });

        async function fetchEventData(eventId, month, category) {
            try {
                let loaderTimeout = setTimeout(() => loader.style.display = 'flex', 500); // Only show if it takes longer than 500ms
            
                const [athleteRes, activityRes] = await Promise.all([
                    fetch(`/athletesByEvent?eventid=${eventId}&month=${month}&category=${category}`),
                    fetch(`/activitiesByEvent?eventid=${eventId}&month=${month}&category=${category}`)
                ]);

                const athletesData  = await athleteRes.json();
                const activityData = await activityRes.json();

                clearTimeout(loaderTimeout);
                loader.style.display = 'none'; // Hide loader

                // ✅ Defensive check
                const athletes = Array.isArray(athletesData.athletes) ? athletesData.athletes : athletesData;

                if (!Array.isArray(athletes)) {
                console.error("❌ Unexpected athlete response:", athletesData);
                return;
                }

                renderCalendar(athletes, activityData.activities);
            } catch (err) {
                console.error("❌ Error fetching event data:", err);
                document.getElementById("calendarBody").innerHTML = `<p style="color: red">❌ Failed to load event data</p>`;
            }
        }



        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/service-worker.js")
                .then(() => console.log("✅ Service Worker Registered!"))
                .catch(error => console.log("❌ Service Worker Registration Failed:", error));
        }

    </script>
    <!-- <script src='https://www.noupe.com/embed/0198ae6285747716a0ad807817842530f55b.js'></script> -->
    <script src='https://www.noupe.com/embed/0198ae99e30c7defabfff814601e305befda.js'></script>
</body>
</html>