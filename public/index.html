<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tej Kadam Foundation</title>
    <style>
        /* Block only the app area, not the whole page lifecycle */
        .i18n-loading #app {
            display: none;
        }

        .i18n-loading #i18n-loader {
            display: flex;
        }

        #i18n-loader {
            display: none;
            align-items: center;
            justify-content: center;
            min-height: 40vh;
            font: 600 14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            color: #ddd;
            gap: 10px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ff7a00;
            opacity: .4;
            animation: b 1s infinite alternate;
        }

        .dot:nth-child(2) {
            animation-delay: .15s
        }

        .dot:nth-child(3) {
            animation-delay: .3s
        }

        @keyframes b {
            to {
                opacity: 1;
                transform: translateY(-2px);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .dot {
                animation: none
            }
        }
    </style>
    <script>document.documentElement.classList.add('i18n-loading');</script>
    <script src="i18n.js" defer></script>
    <script src="script.js" defer></script>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="styles.css">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> -->
</head>

<body>
    <div id="i18n-loader">
        <span data-i18n="ui.loading">Loading</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <div id="app">
        <div class="app-container">
            <header class="app-header">
                <div class="header-content">
                    <div class="header-text">
                        <h1 data-i18n="banner-title"></h1>
                        <h2 data-i18n="banner-subtitle"></h2>
                        <p data-i18n="banner-description"></p>
                        <span data-i18n="event-date" class="date-range"></span>
                        <!-- <p>üë£ Step Up. Stand Out. üë£</p> -->
                    </div>
                </div>
                <div class="theme-toggle"><input type="checkbox" id="theme"></div>
            </header>

            <!-- Main Content -->
            <main class="app-main">
                <div class="lang-toggle">
                    <button id="lang-en" class="lang-btn" data-lang="en">English</button>
                    <button id="lang-hi" class="lang-btn" data-lang="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                </div>

                <div id="leaderboard-container">
                    <!-- <button id="authButton" class="auth-button">
                    <span>Authorize with Strava</span><p class="auth-subtext">*if your name is missing from the list. Your name & data will be display from 1st Aug</p>
                </button> -->
                    <!-- Loader -->
                    <div id="loader" class="loader"><span class="running-emoji">üèÉ‚Äç‚ôÇÔ∏è</span><span data-i18n="ui.loading"
                            class="loading-text"></span></div>

                    <div id="categoryFilters" class="category-filters">
                        <button class="filter-button selected" data-category="50" data-i18n="ui.category.50"></button>
                        <button class="filter-button" data-category="100" data-i18n="ui.category.100"></button>
                        <button class="filter-button" data-category="150" data-i18n="ui.category.150"></button>
                        <button class="filter-button" data-category="200" data-i18n="ui.category.200"></button>
                    </div>

                    <!-- <img class="maintain-img" src="https://twemoji.maxcdn.com/v/latest/svg/1f6e0.svg" alt="Under Construction" />
                <h1 class="maintain-title">We‚Äôre getting ready!</h1>
                <p class="maintain-desc">The tracker is under maintenance as we prepare for the August challenge.<br>
                    Please check back soon. üèÉ‚Äç‚ôÄÔ∏èüèÉ‚Äç‚ôÇÔ∏è
                </p> -->

                    <!-- Medals Section -->
                    <!-- <div class="medals-container" id="medallist">
                    <h2>üèÖ Top Performers</h2><div id="medals" class="medals-grid"><p></p><p></p><p></p></div>
                </div> -->
                    <!-- <div class="medals-container" id="medallist">
                    <h2>üèÖ Leaderboard</h2><div id="medals" class="medals-grid"><p></p><p></p><p></p></div>
                </div> -->

                    <!-- Calendar Table -->
                    <div class="activity-table">
                        <h2 data-i18n="ui.leaderboard"></h2>
                        <!-- <h2>Team Activities</h2> -->
                        <!-- <p class="points-info"><strong>5 mins activity rewards:</strong> üèÉRun - <b>0.9</b>, üßò/üí™ Yoga/Strength - <b>1pts</b></p> -->
                        <p class="glowing-note" data-i18n="ui.note.sync"></p>
                        <input type="text" id="searchAthlete" placeholder="üîç Search Athlete..." class="search-box">
                    </div>
                    <div class="calendar-container" id="actlist">
                        <table id="calendarTable">
                            <thead id="calendarHeader"></thead>
                            <tbody id="calendarBody"></tbody>
                        </table>
                    </div>
                </div>


                <div class="MuiCardContent-root css-15q2cw4">
                    <h4>‡§¨‡§¢‡§º‡§§‡•á ‡§ï‡§¶‡§Æ Virtual Run</h4>
                    <div>
                        <p>Feb 1 - Feb 28, 2026 | Anytime</p>
                    </div>
                    <div class="event-description">
                        <p data-i18n="ui.event.desc"></p>
                        <ol style="padding: 1rem;">
                            <li data-i18n="ui.event.desc1"></li>
                            <li data-i18n="ui.event.desc2"></li>
                            <li data-i18n="ui.event.desc3"></li>
                        </ol>
                        <p data-i18n="ui.event.subdesc"></p>

                        <strong data-i18n="ui.ins.activity"></strong>
                        <ul style="padding: 1rem;">
                            <li data-i18n="ui.ins.activity1"></li>
                            <li data-i18n="ui.ins.activity2"></li>
                            <li data-i18n="ui.ins.activity3"></li>
                            <li data-i18n="ui.ins.activity4"></li>
                        </ul>
                        <strong data-i18n="ui.ins.qualification"></strong>
                        <ul style="padding: 1rem;">
                            <li data-i18n="ui.ins.qualification1"></li>
                            <li data-i18n="ui.ins.qualification2"></li>
                            <li data-i18n="ui.ins.qualification3"></li>
                            <li data-i18n="ui.ins.qualification4"></li>
                        </ul>
                        <strong data-i18n="ui.ins.deliverables"></strong>
                        <ul style="padding: 1rem;">
                            <li data-i18n="ui.ins.deliverables1"></li>
                            <li data-i18n="ui.ins.deliverables2"></li>
                            <li data-i18n="ui.ins.deliverables3"></li>
                            <li data-i18n="ui.ins.deliverables4"></li>
                        </ul>
                        <strong data-i18n="ui.ins.app"></strong>
                        <ul style="padding: 1rem;">
                            <li data-i18n="ui.ins.app1"></li>
                            <li data-i18n="ui.ins.app2"></li>
                            <li data-i18n="ui.ins.app3"></li>
                            <li data-i18n="ui.ins.app4"></li>
                            <li data-i18n="ui.ins.app5"></li>
                        </ul>
            </main>

            <!-- Footer -->
            <footer class="app-footer">
                <div class="social-links">
                    <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook"></i></a>
                    <a href="https://twitter.com" target="_blank"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.instagram.com/noidaextensionrunners/#" target="_blank"><i
                            class="fab fa-instagram"></i></a>
                    <a href="https://strava.com/athletes/123859756" class="strava-badge- strava-badge-follow"
                        target="_blank"><img src="icons/echelon-sprite-24.png" alt="Strava" /></a>
                </div>
                <div>&copy; 2025 Tej Kadam Foundation. All rights reserved.</div>
            </footer>
        </div>
    </div>
    <!-- Activity Details Popup -->
    <div id="activityPopup" class="popup">
        <div class="popup-content">
            <span id="closePopup" class="close" onclick="closePopup('activityPopup')">&times;</span>
            <h3 data-i18n="popup.details.title"></h3>
            <div id="activityDetails"></div>
        </div>
    </div>

    <!-- Athlete Profile Popup -->
    <div id="profilePopup" class="popup">
        <div class="popup-content">
            <span id="closeProfilePopup" class="close" onclick="closePopup('profilePopup')">&times;</span>
            <h3 data-i18n="popup.profile.title"></h3>
            <div id="profileDetails" class="profile-popup-divider">
                <img id="profilePhoto" alt="Profile Photo" class="profile-photo-large">
                align-items: center;
                justify-content: center;
                min-height: 40vh;
                font: 600 14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Arial;
                color: #ddd;
                gap: 10px;
                }

                .dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: #ff7a00;
                opacity: .4;
                animation: b 1s infinite alternate;
                }

                .dot:nth-child(2) {
                animation-delay: .15s
                }

                .dot:nth-child(3) {
                animation-delay: .3s
                }

                @keyframes b {
                to {
                opacity: 1;
                transform: translateY(-2px);
                }
                }

                @media (prefers-reduced-motion: reduce) {
                .dot {
                animation: none
                }
                }
                </style>
                <script>document.documentElement.classList.add('i18n-loading');</script>
                <script src="i18n.js" defer></script>
                <script src="script.js" defer></script>
                <link rel="manifest" href="/manifest.json">
                <link rel="stylesheet" href="styles.css">
                <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
                <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> -->
                </head>

                <body>
                    <div id="i18n-loader">
                        <span data-i18n="ui.loading">Loading</span>
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                    <div id="app">
                        <div class="app-container">
                            <header class="app-header">
                                <div class="header-content">
                                    <div class="header-text">
                                        <h1 data-i18n="banner-title"></h1>
                                        <h2 data-i18n="banner-subtitle"></h2>
                                        <p data-i18n="banner-description"></p>
                                        <span data-i18n="event-date" class="date-range"></span>
                                        <!-- <p>üë£ Step Up. Stand Out. üë£</p> -->
                                    </div>
                                </div>
                                <div class="theme-toggle"><input type="checkbox" id="theme"></div>
                            </header>

                            <!-- Main Content -->
                            <main class="app-main">
                                <div class="lang-toggle">
                                    <button id="lang-en" class="lang-btn" data-lang="en">English</button>
                                    <button id="lang-hi" class="lang-btn" data-lang="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                                </div>

                                <div id="leaderboard-container">
                                    <!-- <button id="authButton" class="auth-button">
                    <span>Authorize with Strava</span><p class="auth-subtext">*if your name is missing from the list. Your name & data will be display from 1st Aug</p>
                </button> -->
                                    <!-- Loader -->
                                    <div id="loader" class="loader"><span class="running-emoji">üèÉ‚Äç‚ôÇÔ∏è</span><span
                                            data-i18n="ui.loading" class="loading-text"></span></div>

                                    <div id="categoryFilters" class="category-filters">
                                        <button class="filter-button selected" data-category="50"
                                            data-i18n="ui.category.50"></button>
                                        <button class="filter-button" data-category="100"
                                            data-i18n="ui.category.100"></button>
                                        <button class="filter-button" data-category="150"
                                            data-i18n="ui.category.150"></button>
                                        <button class="filter-button" data-category="200"
                                            data-i18n="ui.category.200"></button>
                                    </div>

                                    <!-- <img class="maintain-img" src="https://twemoji.maxcdn.com/v/latest/svg/1f6e0.svg" alt="Under Construction" />
                <h1 class="maintain-title">We‚Äôre getting ready!</h1>
                <p class="maintain-desc">The tracker is under maintenance as we prepare for the August challenge.<br>
                    Please check back soon. üèÉ‚Äç‚ôÄÔ∏èüèÉ‚Äç‚ôÇÔ∏è
                </p> -->

                                    <!-- Medals Section -->
                                    <!-- <div class="medals-container" id="medallist">
                    <h2>üèÖ Top Performers</h2><div id="medals" class="medals-grid"><p></p><p></p><p></p></div>
                </div> -->
                                    <!-- <div class="medals-container" id="medallist">
                    <h2>üèÖ Leaderboard</h2><div id="medals" class="medals-grid"><p></p><p></p><p></p></div>
                </div> -->

                                    <!-- Calendar Table -->
                                    <div class="activity-table">
                                        <h2 data-i18n="ui.leaderboard"></h2>
                                        <!-- <h2>Team Activities</h2> -->
                                        <!-- <p class="points-info"><strong>5 mins activity rewards:</strong> üèÉRun - <b>0.9</b>, üßò/üí™ Yoga/Strength - <b>1pts</b></p> -->
                                        <p class="glowing-note" data-i18n="ui.note.sync"></p>
                                        <input type="text" id="searchAthlete" placeholder="üîç Search Athlete..."
                                            class="search-box">
                                    </div>
                                    <div class="calendar-container" id="actlist">
                                        <table id="calendarTable">
                                            <thead id="calendarHeader"></thead>
                                            <tbody id="calendarBody"></tbody>
                                        </table>
                                    </div>
                                </div>


                                <div class="MuiCardContent-root css-15q2cw4">
                                    <h4>‡§¨‡§¢‡§º‡§§‡•á ‡§ï‡§¶‡§Æ Virtual Run</h4>
                                    <div>
                                        <p>Feb 1 - Feb 28, 2026 | Anytime</p>
                                    </div>
                                    <div class="event-description">
                                        <p data-i18n="ui.event.desc"></p>
                                        <ol style="padding: 1rem;">
                                            <li data-i18n="ui.event.desc1"></li>
                                            <li data-i18n="ui.event.desc2"></li>
                                            <li data-i18n="ui.event.desc3"></li>
                                        </ol>
                                        <p data-i18n="ui.event.subdesc"></p>

                                        <strong data-i18n="ui.ins.activity"></strong>
                                        <ul style="padding: 1rem;">
                                            <li data-i18n="ui.ins.activity1"></li>
                                            <li data-i18n="ui.ins.activity2"></li>
                                            <li data-i18n="ui.ins.activity3"></li>
                                            <li data-i18n="ui.ins.activity4"></li>
                                        </ul>
                                        <strong data-i18n="ui.ins.qualification"></strong>
                                        <ul style="padding: 1rem;">
                                            <li data-i18n="ui.ins.qualification1"></li>
                                            <li data-i18n="ui.ins.qualification2"></li>
                                            <li data-i18n="ui.ins.qualification3"></li>
                                            <li data-i18n="ui.ins.qualification4"></li>
                                        </ul>
                                        <strong data-i18n="ui.ins.deliverables"></strong>
                                        <ul style="padding: 1rem;">
                                            <li data-i18n="ui.ins.deliverables1"></li>
                                            <li data-i18n="ui.ins.deliverables2"></li>
                                            <li data-i18n="ui.ins.deliverables3"></li>
                                            <li data-i18n="ui.ins.deliverables4"></li>
                                        </ul>
                                        <strong data-i18n="ui.ins.app"></strong>
                                        <ul style="padding: 1rem;">
                                            <li data-i18n="ui.ins.app1"></li>
                                            <li data-i18n="ui.ins.app2"></li>
                                            <li data-i18n="ui.ins.app3"></li>
                                            <li data-i18n="ui.ins.app4"></li>
                                            <li data-i18n="ui.ins.app5"></li>
                                        </ul>
                            </main>

                            <!-- Footer -->
                            <footer class="app-footer">
                                <div class="social-links">
                                    <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook"></i></a>
                                    <a href="https://twitter.com" target="_blank"><i class="fab fa-twitter"></i></a>
                                    <a href="https://www.instagram.com/noidaextensionrunners/#" target="_blank"><i
                                            class="fab fa-instagram"></i></a>
                                    <a href="https://strava.com/athletes/123859756"
                                        class="strava-badge- strava-badge-follow" target="_blank"><img
                                            src="icons/echelon-sprite-24.png" alt="Strava" /></a>
                                </div>
                                <div>&copy; 2025 Tej Kadam Foundation. All rights reserved.</div>
                            </footer>
                        </div>
                    </div>
                    <!-- Activity Details Popup -->
                    <div id="activityPopup" class="popup">
                        <div class="popup-content">
                            <span id="closePopup" class="close" onclick="closePopup('activityPopup')">&times;</span>
                            <h3 data-i18n="popup.details.title"></h3>
                            <div id="activityDetails"></div>
                        </div>
                    </div>

                    <!-- Athlete Profile Popup -->
                    <div id="profilePopup" class="popup">
                        <div class="popup-content">
                            <span id="closeProfilePopup" class="close"
                                onclick="closePopup('profilePopup')">&times;</span>
                            <h3 data-i18n="popup.profile.title"></h3>
                            <div id="profileDetails" class="profile-popup-divider">
                                <img id="profilePhoto" alt="Profile Photo" class="profile-photo-large">
                                <p id="profileName"></p>
                                <p id="profileActivities"></p>
                            </div>
                        </div>
                    </div>
                    <script defer>
                        // Load dark mode setting
                        document.addEventListener("DOMContentLoaded", async () => {
                            await I18N.init();            // üî¥ ensure dict is loaded first
                            await I18N.whenReady();       // (redundant after init, but safe)

                            // Now it‚Äôs safe to render any dynamic UI that calls I18N.t(...)
                            initLanguageUI();             // set up buttons that call I18N.load('en'|'hi')

                            const authButton = document.getElementById('authButton');
                            const loader = document.getElementById('loader');
                            const calendarBody = document.getElementById('calendarBody');
                            const activityPopup = document.getElementById('activityPopup');
                            const profilePhoto = document.getElementById('profilePhoto');
                            const profileName = document.getElementById('profileName');
                            const profileActivities = document.getElementById('profileActivities');
                            const themeToggle = document.getElementById('theme');


                            // Toggle dark mode and save setting
                            themeToggle.addEventListener("change", () => {
                                const isDarkMode = themeToggle.checked;
                                document.body.setAttribute("data-theme", isDarkMode ? "dark" : "light");
                                localStorage.setItem("darkMode", isDarkMode);
                            });
                            const darkModeEnabled = localStorage.getItem("darkMode") === "true";

                            themeToggle.checked = darkModeEnabled;
                            document.body.setAttribute("data-theme", darkModeEnabled ? "dark" : "light");

                            // Attach search event listener
                            document.getElementById('searchAthlete').addEventListener('input', debounced(filterAthletes, 250));

                            document.querySelectorAll('.filter-button').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('selected'));
                                    btn.classList.add('selected');
                                    const selectedCategory = btn.dataset.category;
                                    fetchEventData("tkfvr2", "1", selectedCategory);
                                });
                            });

                            document.getElementById("calendarHeader").innerHTML = buildHeader(2026, 2);

                            // Initial load
                            await fetchEventData("tkfvr2", "1", "50");
                            document.documentElement.classList.remove('i18n-loading');
                        });

                        async function fetchEventData(eventId, month, category) {
                            try {
                                const loader = document.getElementById('loader');
                                // loader.style.display = 'flex'; // Optional: show loader on re-fetch

                                const [athleteRes, activityRes] = await Promise.all([
                                    fetch(`/athletesByEvent?eventid=${eventId}&month=${month}&category=${category}&pageSize=5000`),
                                    fetch(`/activitiesByEvent?eventid=${eventId}&month=${month}&category=${category}`)
                                ]);

                                const athletesData = await athleteRes.json();
                                const activityData = await activityRes.json();

                                loader.style.display = 'none'; // Hide loader
                                document.querySelector('.app-main').classList.remove('hidden'); // Show content

                                // ‚úÖ Defensive check
                                const athletes = Array.isArray(athletesData.athletes) ? athletesData.athletes : athletesData;

                                console.log(`‚úÖ Fetched ${athletes.length} athletes for category ${category}`);

                                if (!Array.isArray(athletes)) {
                                    console.error("‚ùå Unexpected athlete response:", athletesData);
                                    return;
                                }

                                if (athletes.length === 0) {
                                    document.getElementById("calendarBody").innerHTML = `<tr><td colspan="100%" style="border:none; padding:0;"><div class="empty-state">No athletes found for category ${category}</div></td></tr>`;
                                    return;
                                }

                                renderCalendar(athletes, activityData.activities);
                            } catch (err) {
                                console.error("‚ùå Error fetching event data:", err);
                                document.getElementById("calendarBody").innerHTML = `<p style="color: red">‚ùå Failed to load event data</p>`;
                            }
                        }

                        if ("serviceWorker" in navigator) {
                            navigator.serviceWorker.register("/service-worker.js")
                                .then(() => console.log("‚úÖ Service Worker Registered!"))
                                .catch(error => console.log("‚ùå Service Worker Registration Failed:", error));
                        }

                    </script>
                    <!-- <script src='https://www.noupe.com/embed/0198ae6285747716a0ad807817842530f55b.js'></script> -->
                    <!-- <script src='https://www.noupe.com/embed/0198ae99e30c7defabfff814601e305befda.js'></script> -->
                </body>

</html>